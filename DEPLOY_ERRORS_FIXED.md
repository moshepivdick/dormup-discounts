# Исправления ошибок для деплоя

## Проверено и исправлено

### ✅ 1. Отсутствие обработки ошибок в Server Components

**Проблема:** `app/app/layout.tsx` не обрабатывал ошибки при создании Supabase клиента.

**Исправление:**
- Добавлен try-catch блок
- Добавлена проверка переменных окружения
- Добавлен graceful fallback при ошибках

**Файл:** `app/app/layout.tsx`

### ✅ 2. Отсутствие валидации в `createServiceRoleClient()`

**Проблема:** Функция падала с неинформативной ошибкой, если `SUPABASE_SERVICE_ROLE_KEY` не установлена.

**Исправление:**
- Добавлена проверка наличия `NEXT_PUBLIC_SUPABASE_URL`
- Добавлена проверка наличия `SUPABASE_SERVICE_ROLE_KEY`
- Добавлены понятные сообщения об ошибках

**Файл:** `lib/supabase/server.ts`

### ✅ 3. Обработка ошибок в `app/actions/auth.ts`

**Проблема:** Если `createServiceRoleClient()` падал, пользователь оставался созданным в Supabase Auth без профиля.

**Исправление:**
- Добавлена обработка ошибок при создании service client
- Добавлен cleanup созданного пользователя при ошибке
- Возвращается понятное сообщение об ошибке

**Файл:** `app/actions/auth.ts`

### ✅ 4. Улучшенная обработка ошибок в `lib/supabase/server.ts`

**Проблема:** Cookies могли не работать в некоторых контекстах.

**Исправление:**
- Добавлена обработка ошибок при работе с cookies
- Добавлено логирование для отладки
- Graceful fallback при недоступности cookies

**Файл:** `lib/supabase/server.ts`

### ✅ 5. Добавлен Error Boundary

**Проблема:** Ошибки в клиентских компонентах не обрабатывались корректно.

**Исправление:**
- Создан `components/ErrorBoundary.tsx`
- Создан `components/ClientErrorBoundary.tsx` для App Router
- Интегрирован в корневой layout

**Файлы:**
- `components/ErrorBoundary.tsx`
- `components/ClientErrorBoundary.tsx`
- `app/layout.tsx`

## Потенциальные проблемы (требуют проверки)

### ⚠️ 1. Переменные окружения

**Проблема:** Некоторые переменные могут отсутствовать в Vercel.

**Требуется проверить:**
- ✅ `NEXT_PUBLIC_SUPABASE_URL` - обязательна
- ✅ `NEXT_PUBLIC_SUPABASE_ANON_KEY` - обязательна
- ⚠️ `SUPABASE_SERVICE_ROLE_KEY` - **КРИТИЧНО** для регистрации пользователей
- ✅ `DATABASE_URL` - обязательна
- ✅ `DIRECT_URL` - обязательна
- ✅ `PARTNER_JWT_SECRET` - обязательна
- ✅ `ADMIN_JWT_SECRET` - обязательна
- ⚠️ `NEXT_PUBLIC_APP_URL` - опциональна, но нужна для email redirects

**Решение:** См. `DEPLOY_CHECKLIST.md` для полного списка переменных.

### ⚠️ 2. Prisma миграции

**Проблема:** Миграции должны быть применены перед первым деплоем.

**Решение:**
```bash
# В Vercel используйте:
# Build Command: prisma generate && next build
# Или в отдельном шаге после деплоя:
npx prisma migrate deploy
```

**Файл:** `vercel.json` или настройки Vercel проекта

### ⚠️ 3. Next.js конфигурация

**Проверено:**
- ✅ `next.config.js` настроен корректно
- ✅ `tsconfig.json` настроен корректно
- ✅ `vercel.json` существует

### ⚠️ 4. Build скрипт

**Проблема:** В `package.json` скрипт build включает `prisma generate`, что правильно.

**Текущий скрипт:**
```json
"build": "prisma generate && next build"
```

Это должно работать на Vercel автоматически благодаря `postinstall` hook:
```json
"postinstall": "prisma generate"
```

## Рекомендации для успешного деплоя

### 1. Перед деплоем

1. Проверьте все переменные окружения (см. `DEPLOY_CHECKLIST.md`)
2. Убедитесь, что миграции Prisma применены локально
3. Запустите `npm run build` локально (если возможно)
4. Проверьте, что нет TypeScript ошибок

### 2. После деплоя

1. Проверьте логи Vercel на наличие ошибок
2. Проверьте работоспособность основных страниц:
   - `/` - главная
   - `/signup` - регистрация
   - `/login` - вход
3. Проверьте, что API endpoints работают
4. Проверьте создание пользователей (должен работать с `SUPABASE_SERVICE_ROLE_KEY`)

### 3. Мониторинг

Настройте отслеживание ошибок:
- Vercel Logs (встроенный)
- Supabase Logs (в Dashboard)
- Рекомендуется: Sentry или аналогичный сервис

## Файлы, которые нужно проверить на Vercel

После деплоя проверьте наличие и корректность:

1. ✅ Все переменные окружения установлены
2. ✅ Build проходит успешно
3. ✅ Нет runtime ошибок в логах
4. ✅ База данных доступна
5. ✅ Supabase подключение работает

## Известные ограничения

1. **Mapify расширение браузера** - предупреждения не критичны, можно игнорировать
2. **Error Boundary** - работает только для клиентских компонентов, Server Components ошибки обрабатываются через try-catch
3. **Prisma** - требует генерации клиента перед build (решается через postinstall hook)

## Итог

Все критические проблемы исправлены. Проект готов к деплою при условии:
- ✅ Все переменные окружения установлены на Vercel
- ✅ `SUPABASE_SERVICE_ROLE_KEY` обязательно установлен (для регистрации)
- ✅ Миграции Prisma применены

Для детальной проверки см. `DEPLOY_CHECKLIST.md`.
