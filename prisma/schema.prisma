generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Venue {
  id                Int           @id @default(autoincrement())
  name              String
  city              String
  category          String
  discountText      String
  details           String?
  openingHours      String?
  openingHoursShort String?
  mapUrl            String?
  latitude          Float
  longitude         Float
  imageUrl          String?
  thumbnailUrl      String?
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  discountUses      DiscountUse[]
  partner           Partner?
  views             VenueView[]

  @@index([city])
  @@index([category])
}

model DiscountUse {
  id            Int       @id @default(autoincrement())
  venueId       Int
  userId        String?   @map("user_id")
  generatedCode String    @unique
  status        String    @default("generated")
  qrSlug        String?   @unique
  createdAt     DateTime  @default(now())
  expiresAt     DateTime
  confirmedAt   DateTime?
  venue         Venue     @relation(fields: [venueId], references: [id])
  user          Profile?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([venueId, userId])
}

model Partner {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  venueId      Int       @unique
  createdAt    DateTime  @default(now())
  lastLoginAt  DateTime?
  isActive     Boolean   @default(true)
  venue        Venue     @relation(fields: [venueId], references: [id])
}

model Admin {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  role         String    @default("admin")
  createdAt    DateTime  @default(now())
  lastLoginAt  DateTime?
}

model VenueView {
  id        Int      @id @default(autoincrement())
  venueId   Int
  userId    String?  @map("user_id")
  city      String
  createdAt DateTime @default(now())
  userAgent String?
  venue     Venue    @relation(fields: [venueId], references: [id])
  user      Profile? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([venueId, userId])
  @@index([createdAt])
}

model University {
  id           String   @id @default(uuid())
  name         String   @unique
  city         String
  emailDomains String[] @default([]) @map("email_domains")
  createdAt    DateTime @default(now()) @map("created_at")
  profiles     Profile[]
  requests     UniversityRequest[]

  @@index([emailDomains], type: Gin)
  @@map("universities")
}

model Profile {
  id              String        @id // References auth.users(id)
  email           String
  universityId    String
  verifiedStudent Boolean       @default(false)
  role            String        @default("user")
  createdAt       DateTime      @default(now())
  lastActivityAt  DateTime?     @map("last_activity_at")
  university      University    @relation(fields: [universityId], references: [id], onDelete: Restrict)
  discountUses    DiscountUse[]
  venueViews      VenueView[]
  stats           UserStats?

  @@unique([email])
  @@index([universityId])
  @@index([lastActivityAt])
  @@map("profiles")
}

model UniversityRequest {
  id             String      @id @default(uuid())
  requestedName  String      @map("requested_name")
  requestedCity  String?     @map("requested_city")
  requestedDomains String[]  @default([]) @map("requested_domains")
  requesterEmail String      @map("requester_email")
  status         String      @default("pending")
  notes          String?
  createdAt      DateTime    @default(now())
  universityId   String?     @map("university_id")
  university     University? @relation(fields: [universityId], references: [id])

  @@index([status])
  @@index([requesterEmail])
  @@map("university_requests")
}

model UserStats {
  userId                String   @id @map("user_id")
  totalDiscountsGenerated Int     @default(0) @map("total_discounts_generated")
  totalDiscountsUsed     Int     @default(0) @map("total_discounts_used")
  totalVenueViews        Int     @default(0) @map("total_venue_views")
  lastDiscountGeneratedAt DateTime? @map("last_discount_generated_at")
  lastDiscountUsedAt     DateTime? @map("last_discount_used_at")
  lastVenueViewAt        DateTime? @map("last_venue_view_at")
  updatedAt              DateTime @default(now()) @updatedAt @map("updated_at")
  user                   Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_stats")
}
