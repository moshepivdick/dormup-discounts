generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Venue {
  id                Int           @id @default(autoincrement())
  name              String
  city              String
  category          String
  discountText      String
  details           String?
  openingHours      String?
  openingHoursShort String?
  mapUrl            String?
  latitude          Float
  longitude         Float
  imageUrl          String?
  thumbnailUrl      String?
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  discountUses      DiscountUse[]
  partner           Partner?
  views             VenueView[]

  @@index([city])
  @@index([category])
}

model DiscountUse {
  id            Int       @id @default(autoincrement())
  venueId       Int
  generatedCode String    @unique
  status        String    @default("generated")
  qrSlug        String?   @unique
  createdAt     DateTime  @default(now())
  expiresAt     DateTime
  confirmedAt   DateTime?
  venue         Venue     @relation(fields: [venueId], references: [id])
}

model Partner {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  venueId      Int       @unique
  createdAt    DateTime  @default(now())
  lastLoginAt  DateTime?
  isActive     Boolean   @default(true)
  venue        Venue     @relation(fields: [venueId], references: [id])
}

model Admin {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  role         String    @default("admin")
  createdAt    DateTime  @default(now())
  lastLoginAt  DateTime?
}

model VenueView {
  id        Int      @id @default(autoincrement())
  venueId   Int
  city      String
  createdAt DateTime @default(now())
  userAgent String?
  venue     Venue    @relation(fields: [venueId], references: [id])
}

model University {
  id           String   @id @default(uuid())
  name         String   @unique
  city         String
  emailDomains String[] @default([])
  createdAt    DateTime @default(now())
  profiles     Profile[]
  requests     UniversityRequest[]

  @@index([emailDomains], type: Gin)
  @@map("universities")
}

model Profile {
  id              String    @id // References auth.users(id)
  email           String
  universityId    String
  verifiedStudent Boolean   @default(false)
  role            String     @default("user")
  createdAt       DateTime  @default(now())
  university      University @relation(fields: [universityId], references: [id], onDelete: Restrict)

  @@unique([email])
  @@index([universityId])
  @@map("profiles")
}

model UniversityRequest {
  id             String      @id @default(uuid())
  requestedName  String      @map("requested_name")
  requestedCity  String?     @map("requested_city")
  requestedDomains String[]  @default([]) @map("requested_domains")
  requesterEmail String      @map("requester_email")
  status         String      @default("pending")
  notes          String?
  createdAt      DateTime    @default(now())
  universityId   String?     @map("university_id")
  university     University? @relation(fields: [universityId], references: [id])

  @@index([status])
  @@index([requesterEmail])
  @@map("university_requests")
}
